# 定时任务

定时任务允许您按照预设的时间自动执行数据采集，实现无人值守的自动化数据收集。八爪鱼爬虫支持灵活的定时配置，满足各种自动化采集需求。

## 什么是定时任务？

定时任务是指按照设定的时间规则自动执行采集任务的功能。您可以设置任务在特定时间、每天、每周或按照自定义的时间间隔自动运行。

### 应用场景

**价格监控**
- 每天定时采集商品价格
- 监控价格变化趋势
- 价格异常时发送通知

**内容更新**
- 定时采集新闻文章
- 监控网站内容更新
- 自动归档历史数据

**数据同步**
- 定期同步数据到数据库
- 更新Google Sheets
- 生成定期报表

**竞品分析**
- 定时采集竞品信息
- 跟踪市场动态
- 生成分析报告

## 创建定时任务

### 方法1: 新建任务时设置

1. **创建采集任务**
   - 配置采集规则
   - 测试确认规则正确

2. **启用定时功能**
   - 在任务设置中找到"定时执行"
   - 开启定时功能

3. **配置执行时间**
   - 选择执行频率
   - 或输入Cron表达式
   - 设置开始和结束时间

4. **保存任务**
   - 保存任务配置
   - 任务将按时自动执行

### 方法2: 为现有任务添加定时

1. **打开任务列表**
   - 进入"任务管理"
   - 找到要设置定时的任务

2. **编辑任务**
   - 点击任务的"编辑"按钮
   - 进入任务设置

3. **配置定时**
   - 找到"定时设置"选项
   - 配置执行规则

4. **启用并保存**
   - 启用定时功能
   - 保存设置

## 定时配置方式

### 简单模式

使用预设的常用时间规则。

**每天执行**:
```
执行时间: 每天 09:00
描述: 每天上午9点执行一次
```

**每周执行**:
```
执行时间: 每周一 09:00
描述: 每周一上午9点执行
```

**每月执行**:
```
执行时间: 每月1号 00:00
描述: 每月1号零点执行
```

**间隔执行**:
```
执行间隔: 每2小时
描述: 每隔2小时执行一次
```

### Cron表达式模式

使用Cron表达式实现更灵活的定时配置。

#### Cron表达式格式

```
* * * * *
│ │ │ │ │
│ │ │ │ └─── 星期 (0-7, 0和7都表示周日)
│ │ │ └───── 月份 (1-12)
│ │ └─────── 日期 (1-31)
│ └───────── 小时 (0-23)
└─────────── 分钟 (0-59)
```

#### 常用表达式示例

**每天定时**:
```cron
# 每天上午9点
0 9 * * *

# 每天下午2点30分
30 14 * * *

# 每天中午12点和晚上6点
0 12,18 * * *
```

**每周定时**:
```cron
# 每周一上午9点
0 9 * * 1

# 工作日上午9点
0 9 * * 1-5

# 周末上午10点
0 10 * * 0,6
```

**每月定时**:
```cron
# 每月1号零点
0 0 1 * *

# 每月15号中午12点
0 12 15 * *

# 每月最后一天
0 0 L * *
```

**间隔执行**:
```cron
# 每小时执行
0 * * * *

# 每2小时执行
0 */2 * * *

# 每30分钟执行
*/30 * * * *

# 每15分钟执行
*/15 * * * *
```

**特定时间段**:
```cron
# 工作日的9点到18点，每小时执行
0 9-18 * * 1-5

# 每天早上6点到晚上10点，每2小时执行
0 6-22/2 * * *
```

#### Cron表达式特殊字符

| 字符 | 说明 | 示例 |
|------|------|------|
| * | 任意值 | `* * * * *` 每分钟 |
| , | 列举值 | `0 9,12,18 * * *` 9点、12点、18点 |
| - | 范围值 | `0 9-17 * * *` 9点到17点 |
| / | 间隔值 | `*/10 * * * *` 每10分钟 |
| L | 最后 | `0 0 L * *` 每月最后一天 |
| W | 工作日 | `0 0 15W * *` 15号最近的工作日 |
| # | 第几个 | `0 0 * * 1#2` 每月第二个周一 |

### 高级配置

**执行窗口**:
```json
{
  "cron": "0 9 * * *",
  "window": {
    "start": "2024-01-01",
    "end": "2024-12-31"
  }
}
```

**执行次数限制**:
```json
{
  "cron": "0 */2 * * *",
  "maxExecutions": 10
}
```

**跳过节假日**:
```json
{
  "cron": "0 9 * * 1-5",
  "skipHolidays": true,
  "holidayCalendar": "CN"
}
```

## 任务执行管理

### 查看执行计划

查看任务的下次执行时间和执行历史。

**执行计划信息**:
```
任务名称: 商品价格监控
Cron表达式: 0 9 * * *
下次执行: 2024-01-16 09:00:00
上次执行: 2024-01-15 09:00:00
执行状态: 成功
```

### 执行历史

查看任务的历史执行记录。

**历史记录包含**:
- 执行时间
- 执行状态 (成功/失败)
- 采集数据量
- 执行耗时
- 错误信息 (如果失败)

**示例**:
```
2024-01-15 09:00:00 | 成功 | 1000条 | 5分30秒
2024-01-14 09:00:00 | 成功 | 980条 | 5分15秒
2024-01-13 09:00:00 | 失败 | 0条 | 网络超时
2024-01-12 09:00:00 | 成功 | 1020条 | 5分45秒
```

### 手动触发

即使配置了定时，也可以随时手动执行任务。

1. 打开任务列表
2. 找到要执行的任务
3. 点击"立即执行"按钮
4. 任务开始运行

**注意**: 手动执行不影响定时计划。

### 暂停和恢复

临时暂停定时任务，需要时再恢复。

**暂停任务**:
1. 打开任务设置
2. 关闭"启用定时"开关
3. 保存设置

**恢复任务**:
1. 打开任务设置
2. 开启"启用定时"开关
3. 保存设置

### 删除定时

完全删除任务的定时配置。

1. 打开任务设置
2. 进入"定时设置"
3. 点击"删除定时"
4. 确认删除

**注意**: 删除定时不会删除任务本身。

## 执行通知

### 通知类型

**任务开始通知**:
```
标题: 定时任务开始执行
内容: 任务"商品价格监控"开始执行
时间: 2024-01-15 09:00:00
```

**任务完成通知**:
```
标题: 定时任务执行成功
内容: 任务"商品价格监控"执行完成
数据: 采集1000条数据
耗时: 5分30秒
```

**任务失败通知**:
```
标题: 定时任务执行失败
内容: 任务"商品价格监控"执行失败
错误: 网络连接超时
建议: 请检查网络连接后重试
```

### 通知方式

**浏览器通知**:
- Chrome原生通知
- 需要授权通知权限
- 浏览器打开时可见

**邮件通知**:
```json
{
  "notification": {
    "email": {
      "enabled": true,
      "to": "your@email.com",
      "onSuccess": false,
      "onFailure": true
    }
  }
}
```

**Webhook通知**:
```json
{
  "notification": {
    "webhook": {
      "enabled": true,
      "url": "https://your-webhook-url.com",
      "method": "POST",
      "headers": {
        "Authorization": "Bearer your-token"
      }
    }
  }
}
```

**钉钉/企业微信**:
```json
{
  "notification": {
    "dingtalk": {
      "enabled": true,
      "webhook": "https://oapi.dingtalk.com/robot/send?access_token=xxx",
      "atMobiles": ["13812345678"]
    }
  }
}
```

### 通知条件

配置何时发送通知。

**总是通知**:
```json
{
  "notifyOn": "always"
}
```

**仅失败时通知**:
```json
{
  "notifyOn": "failure"
}
```

**仅成功时通知**:
```json
{
  "notifyOn": "success"
}
```

**条件通知**:
```json
{
  "notifyOn": "condition",
  "conditions": [
    {
      "type": "dataCount",
      "operator": "<",
      "value": 100,
      "message": "采集数据量少于预期"
    },
    {
      "type": "duration",
      "operator": ">",
      "value": 600,
      "message": "执行时间超过10分钟"
    }
  ]
}
```

## 错误处理

### 自动重试

任务执行失败时自动重试。

```json
{
  "retry": {
    "enabled": true,
    "maxAttempts": 3,
    "interval": 300,
    "backoff": "exponential"
  }
}
```

**重试策略**:
- **固定间隔**: 每次重试间隔相同
- **指数退避**: 重试间隔逐渐增加 (5分钟、10分钟、20分钟)
- **线性增加**: 重试间隔线性增加 (5分钟、10分钟、15分钟)

### 失败处理

配置任务失败后的处理方式。

**继续执行**:
```json
{
  "onFailure": "continue",
  "skipToNext": true
}
```

**暂停任务**:
```json
{
  "onFailure": "pause",
  "requireManualResume": true
}
```

**发送告警**:
```json
{
  "onFailure": "alert",
  "alertChannels": ["email", "webhook"]
}
```

### 超时设置

设置任务执行的最大时间。

```json
{
  "timeout": {
    "enabled": true,
    "duration": 1800,
    "action": "abort"
  }
}
```

**超时动作**:
- **abort**: 中止任务
- **continue**: 继续执行
- **savePartial**: 保存已采集的数据

## 并发控制

### 防止重复执行

确保同一任务不会同时执行多次。

```json
{
  "concurrency": {
    "preventOverlap": true,
    "skipIfRunning": true
  }
}
```

**处理策略**:
- **跳过**: 如果任务正在运行，跳过本次执行
- **排队**: 等待当前执行完成后再执行
- **中止**: 中止当前执行，开始新的执行

### 任务优先级

设置多个定时任务的执行优先级。

```json
{
  "priority": "high",
  "maxConcurrent": 3
}
```

**优先级**:
- **high**: 高优先级，优先执行
- **normal**: 普通优先级
- **low**: 低优先级，最后执行

## 资源管理

### 执行时段限制

限制任务只在特定时段执行。

```json
{
  "executionWindow": {
    "allowedHours": [0, 1, 2, 3, 4, 5, 22, 23],
    "timezone": "Asia/Shanghai"
  }
}
```

**应用场景**:
- 避开网站高峰期
- 利用夜间时段采集
- 遵守网站访问限制

### 资源限制

限制任务使用的系统资源。

```json
{
  "resources": {
    "maxMemory": "2GB",
    "maxCPU": "50%",
    "maxDuration": "30m"
  }
}
```

## 高级功能

### 任务链

按顺序执行多个任务。

```json
{
  "taskChain": {
    "enabled": true,
    "tasks": [
      {
        "taskId": "task-1",
        "waitForCompletion": true
      },
      {
        "taskId": "task-2",
        "waitForCompletion": true
      },
      {
        "taskId": "task-3",
        "waitForCompletion": false
      }
    ]
  }
}
```

**执行流程**:
```
任务1 → 等待完成 → 任务2 → 等待完成 → 任务3 → 不等待
```

### 条件执行

根据条件决定是否执行任务。

```json
{
  "conditionalExecution": {
    "enabled": true,
    "conditions": [
      {
        "type": "dataChange",
        "source": "task-1",
        "threshold": 10
      },
      {
        "type": "timeRange",
        "start": "09:00",
        "end": "18:00"
      }
    ],
    "operator": "AND"
  }
}
```

### 增量采集

只采集新增或变更的数据。

```json
{
  "incremental": {
    "enabled": true,
    "compareField": "id",
    "lastRunData": "stored"
  }
}
```

**工作原理**:
1. 记录上次采集的数据
2. 本次采集时对比
3. 只保存新增或变更的数据

## 监控和日志

### 执行监控

实时监控任务执行状态。

**监控指标**:
- 执行状态
- 采集进度
- 数据量统计
- 资源使用情况
- 错误信息

### 日志记录

详细记录任务执行过程。

**日志级别**:
- **DEBUG**: 调试信息
- **INFO**: 一般信息
- **WARN**: 警告信息
- **ERROR**: 错误信息

**日志内容**:
```
[2024-01-15 09:00:00] INFO 任务开始执行
[2024-01-15 09:00:05] INFO 页面加载完成
[2024-01-15 09:00:10] INFO 开始采集列表数据
[2024-01-15 09:02:30] INFO 采集第1页，获取50条数据
[2024-01-15 09:05:00] INFO 采集第2页，获取48条数据
[2024-01-15 09:05:30] INFO 任务执行完成，共采集1000条数据
```

### 性能分析

分析任务执行性能。

**性能指标**:
- 总执行时间
- 页面加载时间
- 数据提取时间
- 网络请求时间
- 数据处理时间

## 最佳实践

### 1. 合理设置执行频率

✅ **推荐**:
- 根据数据更新频率设置
- 避免过于频繁的执行
- 考虑网站的访问限制
- 错开高峰时段

❌ **避免**:
- 每分钟执行
- 同时执行大量任务
- 不考虑网站负载
- 忽略反爬虫限制

### 2. 配置合适的通知

✅ **推荐**:
- 失败时发送通知
- 异常情况发送告警
- 定期发送执行报告
- 使用多种通知方式

❌ **避免**:
- 每次执行都通知
- 通知信息不明确
- 只使用单一通知方式
- 忽略通知失败

### 3. 做好错误处理

✅ **推荐**:
- 配置自动重试
- 设置合理的超时
- 记录详细的错误日志
- 定期检查执行状态

❌ **避免**:
- 不处理错误
- 无限重试
- 忽略超时
- 不记录日志

### 4. 监控任务执行

✅ **推荐**:
- 定期查看执行历史
- 分析性能指标
- 优化执行效率
- 及时处理异常

❌ **避免**:
- 设置后不管
- 不查看执行结果
- 忽略性能问题
- 不处理失败任务

## 故障排除

### 问题1: 定时任务没有执行

**可能原因**:
- 任务未启用
- Cron表达式错误
- 浏览器未打开
- 系统时间不正确

**解决方法**:
1. 检查任务是否启用
2. 验证Cron表达式
3. 确保浏览器打开
4. 检查系统时间设置

### 问题2: 任务执行失败

**可能原因**:
- 网络连接问题
- 网站结构变化
- 选择器失效
- 反爬虫限制

**解决方法**:
1. 检查网络连接
2. 更新采集规则
3. 调整选择器
4. 降低采集频率

### 问题3: 收不到通知

**可能原因**:
- 通知未启用
- 通知配置错误
- 权限未授予
- 网络问题

**解决方法**:
1. 检查通知设置
2. 验证配置信息
3. 授予通知权限
4. 测试通知功能

## 下一步

- [批量采集](./batch-collection) - 批量采集多个目标
- [数据处理](./data-processing) - 处理采集的数据
- [三方集成](./integrations) - 集成外部服务
- [实战教程](./tutorials) - 完整的自动化采集案例
