# 可视化规则开发

可视化规则开发是八爪鱼爬虫的高级功能，通过图形化界面创建复杂的数据采集规则，支持多级深度采集、条件判断、数据处理等高级特性。

## 什么是可视化规则？

可视化规则使用流程图的方式展示采集逻辑，每个节点代表一个操作步骤，节点之间通过连线表示执行顺序。这种方式让复杂的采集流程变得直观易懂。

### 与智能采集的区别

| 特性 | 智能采集 | 可视化规则 |
|------|---------|-----------|
| 创建方式 | AI自动生成 | 手动配置 |
| 适用场景 | 标准化页面 | 复杂场景 |
| 灵活性 | 中等 | 非常高 |
| 学习曲线 | 低 | 中等 |
| 自定义程度 | 有限 | 完全自定义 |

## 可视化编辑器界面

### 界面布局

```
┌─────────────────────────────────────────────────────┐
│  工具栏: [保存] [运行] [调试] [导出]                  │
├──────────┬──────────────────────────────────────────┤
│          │                                          │
│  节点库  │          画布区域                         │
│          │      (拖拽节点创建流程)                   │
│  ├起始   │                                          │
│  ├页面   │                                          │
│  ├列表   │                                          │
│  └详情   │                                          │
│          │                                          │
├──────────┴──────────────────────────────────────────┤
│  属性面板: 节点配置和字段设置                         │
└─────────────────────────────────────────────────────┘
```

### 主要组件

**1. 工具栏**
- 保存规则
- 运行测试
- 调试模式
- 导出规则

**2. 节点库**
- 起始节点
- 页面节点
- 列表节点
- 详情节点

**3. 画布区域**
- 拖拽创建节点
- 连接节点
- 调整布局
- 缩放视图

**4. 属性面板**
- 节点配置
- 字段设置
- 数据处理
- 高级选项

## 创建可视化规则

### 步骤1: 创建新规则

1. 打开插件主界面
2. 点击"新建任务"
3. 选择"高级采集模式"
4. 进入可视化编辑器

### 步骤2: 添加起始节点

起始节点是规则的入口，必须首先配置。

**配置项：**

```yaml
URL: https://example.com/products
视口大小:
  宽度: 1920
  高度: 1080
HTTP Headers:
  - User-Agent: Mozilla/5.0...
  - Accept-Language: zh-CN
初始步骤:
  - 等待页面加载
  - 关闭弹窗广告
```

**示例配置：**

1. 在画布中自动存在起始节点
2. 点击起始节点
3. 在属性面板中配置：
   - 输入目标URL
   - 设置浏览器窗口大小
   - 添加自定义HTTP头（可选）
   - 配置初始化步骤（可选）

### 步骤3: 添加数据采集节点

根据采集需求添加相应的节点。

#### 场景1: 简单列表采集

**目标**: 采集商品列表页的商品信息

**流程**:
```
起始节点 → 列表节点
```

**列表节点配置**:

1. **列表选择器**
   ```css
   .product-list .product-item
   ```

2. **字段配置**
   ```json
   [
     {
       "name": "title",
       "selector": ".title",
       "attr": "innerText"
     },
     {
       "name": "price",
       "selector": ".price",
       "attr": "innerText",
       "extractor": {
         "type": "regex",
         "code": "\\d+\\.\\d+"
       }
     },
     {
       "name": "image",
       "selector": "img",
       "attr": "src"
     }
   ]
   ```

3. **翻页配置**
   ```json
   {
     "type": "click_next",
     "config": {
       "selector": ".next-page"
     }
   }
   ```

#### 场景2: 列表+详情深度采集

**目标**: 先采集列表，再进入每个详情页采集更多信息

**流程**:
```
起始节点 → 列表节点 → 页面节点 → 详情节点
```

**配置步骤**:

1. **列表节点**: 采集基本信息和详情链接
   ```json
   {
     "fields": [
       {
         "name": "title",
         "selector": ".title",
         "attr": "innerText"
       },
       {
         "name": "detailUrl",
         "selector": "a.detail-link",
         "attr": "href"
       }
     ]
   }
   ```

2. **页面节点**: 打开详情页
   ```json
   {
     "type": "click_element",
     "value": "a.detail-link"
   }
   ```

3. **详情节点**: 采集详细信息
   ```json
   {
     "fields": [
       {
         "name": "description",
         "selector": ".description",
         "attr": "innerText"
       },
       {
         "name": "specifications",
         "selector": ".specs",
         "attr": "innerText"
       }
     ]
   }
   ```

#### 场景3: 多级分类采集

**目标**: 遍历所有分类，采集每个分类下的商品

**流程**:
```
起始节点 → 列表节点(分类) → 页面节点 → 列表节点(商品)
```

**配置说明**:

1. **第一个列表节点**: 采集所有分类链接
2. **页面节点**: 进入每个分类页面
3. **第二个列表节点**: 采集该分类下的商品

### 步骤4: 配置字段

为每个采集节点配置要提取的字段。

#### 添加字段

**方法1: 点选添加**
1. 点击"添加字段"按钮
2. 在页面预览中点击目标元素
3. 系统自动生成选择器
4. 输入字段名称
5. 选择提取属性

**方法2: 手动添加**
1. 点击"添加字段"按钮
2. 手动输入字段名称
3. 输入CSS选择器或XPath
4. 选择提取属性
5. 配置数据处理（可选）

#### 字段配置选项

**基本配置**:
```json
{
  "name": "price",           // 字段名称
  "selector": ".price",      // 元素选择器
  "attr": "innerText",       // 提取属性
  "required": true,          // 是否必需
  "defaultValue": "0"        // 默认值
}
```

**高级配置**:
```json
{
  "name": "price",
  "selector": ".price",
  "attr": "innerText",
  "extractor": {
    "type": "regex",         // 提取器类型
    "code": "\\d+\\.\\d+"    // 提取规则
  },
  "transformer": {
    "type": "js",            // 转换器类型
    "code": "return parseFloat(value)"
  }
}
```

### 步骤5: 配置翻页

为列表节点配置翻页规则。

#### 点击下一页

```json
{
  "type": "click_next",
  "config": {
    "selector": ".pagination .next",
    "maxPages": 10,
    "interval": 2000
  }
}
```

#### 无限滚动

```json
{
  "type": "scroll",
  "config": {
    "selector": "body",
    "maxScrolls": 20,
    "interval": 1000
  }
}
```

#### 加载更多

```json
{
  "type": "load_more",
  "config": {
    "selector": ".load-more-btn",
    "maxClicks": 10,
    "interval": 1500
  }
}
```

### 步骤6: 添加操作步骤

在节点中添加自动化操作步骤。

#### 常用步骤

**点击操作**:
```json
{
  "type": "click",
  "selectors": [["button.close-ad"]]
}
```

**输入文本**:
```json
{
  "type": "change",
  "selectors": [["input.search"]],
  "value": "搜索关键词"
}
```

**等待加载**:
```json
{
  "type": "wait",
  "timeout": 3000
}
```

**滚动页面**:
```json
{
  "type": "scroll",
  "x": 0,
  "y": 1000
}
```

#### 步骤组合示例

**登录操作**:
```json
{
  "steps": [
    {
      "type": "change",
      "selectors": [["input[name='username']"]],
      "value": "your_username"
    },
    {
      "type": "change",
      "selectors": [["input[name='password']"]],
      "value": "your_password"
    },
    {
      "type": "click",
      "selectors": [["button[type='submit']"]]
    },
    {
      "type": "wait",
      "timeout": 2000
    }
  ]
}
```

**搜索操作**:
```json
{
  "steps": [
    {
      "type": "change",
      "selectors": [["input.search-box"]],
      "value": "iPhone 15"
    },
    {
      "type": "keyDown",
      "key": "Enter"
    },
    {
      "type": "wait",
      "timeout": 2000
    }
  ]
}
```

### 步骤7: 测试和调试

在保存规则前，先测试确保规则正确。

#### 运行测试

1. 点击工具栏的"运行"按钮
2. 观察采集过程
3. 查看采集结果
4. 检查数据完整性

#### 调试模式

启用调试模式可以：
- 逐步执行节点
- 查看中间数据
- 检查选择器匹配
- 查看详细日志

#### 常见问题排查

**问题1: 选择器找不到元素**
- 检查选择器是否正确
- 确认页面已加载完成
- 尝试使用更简单的选择器

**问题2: 数据提取不完整**
- 检查字段配置
- 确认元素属性正确
- 查看是否需要等待加载

**问题3: 翻页不工作**
- 检查翻页选择器
- 确认翻页类型正确
- 查看是否有反爬虫限制

### 步骤8: 保存和运行

测试通过后保存规则并运行。

1. 点击"保存"按钮
2. 输入规则名称和描述
3. 选择保存位置（本地/云端）
4. 点击"运行"开始采集

## 高级技巧

### 1. 使用变量

在规则中使用变量实现动态配置。

**定义变量**:
```json
{
  "variables": {
    "keyword": "iPhone",
    "maxPages": 10,
    "category": "手机"
  }
}
```

**使用变量**:
```json
{
  "url": "https://example.com/search?q={{keyword}}",
  "pagination": {
    "maxPages": "{{maxPages}}"
  }
}
```

### 2. 条件判断

根据条件执行不同的采集逻辑。

```json
{
  "condition": {
    "field": "price",
    "operator": ">",
    "value": 1000
  },
  "then": {
    // 价格大于1000时的操作
  },
  "else": {
    // 价格小于等于1000时的操作
  }
}
```

### 3. 数据转换

对采集的数据进行转换处理。

**价格转换**:
```javascript
// 输入: "¥1,999.00"
// 输出: 1999.00
return parseFloat(value.replace(/[^0-9.]/g, ''))
```

**日期转换**:
```javascript
// 输入: "2小时前"
// 输出: "2024-01-15 14:30:00"
const now = new Date()
const hours = parseInt(value)
now.setHours(now.getHours() - hours)
return now.toISOString()
```

**文本清洗**:
```javascript
// 去除多余空白和换行
return value.trim().replace(/\s+/g, ' ')
```

### 4. 循环采集

对列表中的每一项执行相同的操作。

```json
{
  "loop": {
    "selector": ".product-item",
    "actions": [
      {
        "type": "click",
        "selector": ".detail-btn"
      },
      {
        "type": "extract",
        "fields": [...]
      },
      {
        "type": "back"
      }
    ]
  }
}
```

### 5. 错误处理

配置错误处理策略。

```json
{
  "errorHandling": {
    "onSelectorNotFound": "skip",     // 跳过
    "onTimeout": "retry",             // 重试
    "onNetworkError": "abort",        // 中止
    "maxRetries": 3,
    "retryInterval": 5000
  }
}
```

## 实战案例

### 案例1: 电商商品采集

**需求**: 采集某电商网站的手机商品信息

**规则设计**:

```
起始节点(搜索页) 
  → 列表节点(商品列表) 
  → 页面节点(详情页) 
  → 详情节点(详细信息)
```

**配置要点**:
1. 起始节点配置搜索URL
2. 列表节点采集商品标题、价格、链接
3. 页面节点打开详情页
4. 详情节点采集详细参数、评论等
5. 配置翻页采集多页数据

### 案例2: 新闻文章采集

**需求**: 采集新闻网站的最新文章

**规则设计**:

```
起始节点(首页) 
  → 列表节点(文章列表) 
  → 页面节点(文章页) 
  → 详情节点(文章内容)
```

**配置要点**:
1. 列表节点采集文章标题、摘要、链接
2. 详情节点采集完整正文、作者、时间
3. 处理相对时间转换
4. 清洗HTML标签

### 案例3: 招聘信息采集

**需求**: 采集招聘网站的职位信息

**规则设计**:

```
起始节点(搜索页) 
  → 列表节点(职位列表) 
  → 页面节点(职位详情) 
  → 详情节点(详细要求)
```

**配置要点**:
1. 配置搜索关键词和地区
2. 采集职位名称、公司、薪资
3. 采集详细的职位描述和要求
4. 处理薪资范围数据

## 最佳实践

### 1. 规则设计原则

✅ **推荐**:
- 保持规则简洁清晰
- 合理划分节点职责
- 使用有意义的字段名
- 添加注释说明

❌ **避免**:
- 过度复杂的嵌套
- 重复的配置
- 模糊的命名
- 缺少错误处理

### 2. 选择器编写

✅ **推荐**:
- 使用稳定的选择器
- 优先使用ID和语义化class
- 适当的层级深度
- 测试选择器的唯一性

❌ **避免**:
- 动态生成的class
- 过深的层级嵌套
- 依赖元素位置
- 不稳定的属性

### 3. 性能优化

✅ **推荐**:
- 只采集必要的字段
- 设置合理的等待时间
- 使用增量采集
- 控制并发数量

❌ **避免**:
- 采集大量无用数据
- 过短的请求间隔
- 重复采集相同数据
- 无限制的翻页

### 4. 数据质量

✅ **推荐**:
- 验证数据完整性
- 清洗和格式化数据
- 设置默认值
- 记录采集日志

❌ **避免**:
- 不验证数据
- 保留原始脏数据
- 忽略异常值
- 不记录错误

## 下一步

- [数据导出](./data-export) - 了解如何导出采集的数据
- [定时任务](./scheduled-tasks) - 设置自动化采集
- [批量采集](./batch-collection) - 批量采集多个目标
- [实战教程](./tutorials) - 更多实战案例
